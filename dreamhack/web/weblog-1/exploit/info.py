import os
import re

TARGET_FILE = '/home/navy356/CTFs/dreamhack/weblog-1/access.log'


def find_character(line):
    pass


def dbName():
    f = open(TARGET_FILE)
    lines=f.readlines()

    name=""
    pattern='.*GET \/board\.php\?sort=if\(ord\(substr\(database\(\),%20(?P<index>\d+),1\)\)=(?P<ch>\d+),%20\(select%201%20union%20select%202\),%200\) HTTP\/1\.1" (?P<code>\d{3}) .*'
    for line in lines:
        match=re.search(pattern,line)
        if match:
            match=match.groupdict()
            if match['code']=='500':
                name=name+chr(int(match['ch']))

    return name

def dbInfo():
    f = open(TARGET_FILE)
    lines=f.readlines()

    info=""
    pattern='.*GET \/board\.php\?sort=if\(ord\(substr\(\(select%20group_concat\(TABLE_NAME,0x3a,COLUMN_NAME\)%20from%20information_schema\.columns%20where%20TABLE_SCHEMA=database\(\)\),%20(?P<index>\d+),1\)\)=(?P<ch>\d+),%20\(select%201%20union%20select%202\),%200\) HTTP\/1\.1" (?P<code>\d{3}) .*'
    for line in lines:
        match=re.search(pattern,line)
        if match:
            match=match.groupdict()
            if match['code']=='500':
                info=info+chr(int(match['ch']))

    info=info.split(',')
    tables=dict()

    for name in info:
        table,column=name.split(':')
        if table not in tables:
            tables[table]=list()

        tables[table].append(column)

    return tables

def userInfo():
    f = open(TARGET_FILE)
    lines=f.readlines()

    info=""
    pattern='.*GET \/board\.php\?sort=if\(ord\(substr\(\(select%20group_concat\(username,0x3a,password\)%20from%20users\),%20(?P<index>\d+),1\)\)=(?P<ch>\d+),%20\(select%201%20union%20select%202\),%200\) HTTP\/1\.1" (?P<code>\d{3}) .*'

    for line in lines:
        match=re.search(pattern,line)
        if match:
            match=match.groupdict()
            if match['code']=='500':
                info=info+chr(int(match['ch']))

    info=info.split(',')
    users=dict()

    for user in info:
        username, password = user.split(':')
        users[username]=password

    print(users)

print('Starting')
dbName()
dbInfo()
userInfo()