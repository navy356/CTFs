<?php

// Set some useful constants that the core may require or use
define("IN_MYBB", 1);
define('THIS_SCRIPT', 'my_plugin.php');


// Including global.php gives us access to a bunch of MyBB functions and variables
require_once "./global.php";

function validate_additional_info($additional_info) {
    $validated = array();
    foreach($additional_info as $key => $value) {
        switch ($key) {
            case "reliability": {
                $value = (int)$value;
                if ($value >= 0 && $value <= 100) {
                    $validated["reliability"] = $value;
                }
                break;
            }
            case "impact": {
                $valid_impacts = array("rce", "priv_esc", "information_disclosure");
                if (in_array($value, $valid_impacts, true)) {
                    $validated["impact"] = $value;
                }
                break;
            }
            case "current_bidding":
            case "sold_to": {
                $validated[$key] = (int)$value;
                break;
            }
            default: {
                $validated[$key] = $value;
            }
        }
    }

    return $validated;
}

if (!file_exists("/tmp/.installed")) {

    if (!$db->table_exists("exploit_proposals")) {
        $db->write_query("CREATE TABLE mybb_exploit_proposals ( pid INT PRIMARY KEY AUTO_INCREMENT );");
        $db->add_column("exploit_proposals", "uid", "INT NOT NULL");
        $db->add_column("exploit_proposals", "software", "TEXT");
        $db->add_column("exploit_proposals", "description", "TEXT");
        $db->add_column("exploit_proposals", "latest_version", "INT");
        $db->add_column("exploit_proposals", "additional_info", "TEXT");
    }

    $db->delete_query("exploit_proposals");
    file_put_contents("/tmp/.installed", "ok");
}


ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

if($mybb->user['uid'] == '/' || $mybb->user['uid'] == 0)
{
	error_no_permission();
}

$action = $mybb->get_input("action");
if ($action === "make_proposal") {
    
    
    // validate additional info
    $proposal = array(
        "uid" => (int)$mybb->user['uid'],
        "software" => $db->escape_string($mybb->get_input("software")),
        "latest_version" => $mybb->get_input("latest_version", MyBB::INPUT_BOOL) ? 1 : 0,
        "description" => $db->escape_string($mybb->get_input("description")),
        "additional_info" => $db->escape_string(
            my_serialize(
                validate_additional_info(
                    $mybb->get_input("additional_info", MyBB::INPUT_ARRAY)
                    )
                )
            )
    );
    $res = $db->insert_query("exploit_proposals", $proposal);

    echo "OK!";

} else if ($action === "delete_proposals") {
    $db->delete_query("exploit_proposals", "uid=" . (int)$mybb->user['uid']);
}