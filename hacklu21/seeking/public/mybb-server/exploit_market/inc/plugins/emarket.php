<?php

// Disallow direct access to this file for security reasons
if(!defined("IN_MYBB"))
{
	die("Direct initialization of this file is not allowed.");
}

$plugins->add_hook("member_do_register_end", "activate_user");

// auto-activate any users that register -- emails can be used to track exploit buyers ;)
function activate_user() {
	global $db;
	global $cache;
	global $user_info;
	global $mbb;
	
	
	$db->write_query("DELETE FROM mybb_awaitingactivation;");
	$cache->delete("awaitingactivation");

	// set to a normal user
	$db->write_query("UPDATE mybb_users SET usergroup=2 WHERE uid=" . $user_info['uid']);
}


// include the proposals of the user at the end of each PM
$plugins->add_hook("private_read_end", 'list_proposals');

// this plugin adds a list of exploit proposals to the end of a PM a user sends
function list_proposals() {
	global $db;
	// this variable contains the PM
	global $message;
	global $mybb;
	global $pm;
	$query = $db->simple_select("exploit_proposals", "*", "uid=" . (int)$pm['fromid']);
    $proposals = array();
    while($proposal = $db->fetch_array($query)) {
        $proposal['additional_info'] = my_unserialize($proposal['additional_info']);
        
        // resolve the buyer's ID to a username
        if (array_key_exists("sold_to", $proposal["additional_info"])) {
            $user_query = $db->simple_select("users", "username", "uid=" . $proposal["additional_info"]['sold_to']);
            $buyer = $db->fetch_array($user_query);
            $proposal["buyer"] = $buyer["username"];
        }

        array_push($proposals, $proposal);
    }
	if (count($proposals) > 0) {
		$message .= "<b>Their exploit proposals:</b><br />";
	}

	foreach($proposals as $proposal) {
		$message .= "<hr />";
		foreach($proposal as $field => $value) {
			if (is_array($value)) {
				continue;
			}
			$message .= "<b>" . htmlspecialchars($field) . ": </b>";
			$message .= "<i>" . htmlspecialchars($value) . " </i>";
		}
	}	
}


function emarket_info()
{
	return array(
		"name"			=> "ExploitMarket",
		"description"	=> "A MyBB integration for the ExploitMarket. It has an API for adding Exploit proposals and automatically adds them to all outgoing Private Messages.",
		"website"		=> "",
		"author"		=> "TotallyNotAGovernment",
		"authorsite"	=> "",
		"version"		=> "13.37",
		"guid" 			=> "",
		"codename"		=> "",
		"compatibility" => "*"
	);
}

function emarket_install()
{

}

function emarket_is_installed()
{

}